<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* --- Base Styles (Dark Background) --- */
        body {
            background-color: #3f3f3f;
            color: #ccc;
        }
        .custom-math-field {
            width: 100%;
            min-height: 40px;
        }
        .clearButton {
            white-space: nowrap;
        }

        /* --- Orangish Button Style --- */
        .copy-all-btn, .clearAll {
            background-color: #ff9900; /* Bright Orange */
            color: #3f3f3f;
            border: 1px solid #ff9900;
            font-weight: bold;
        }
        .copy-all-btn:hover, .clearAll:hover {
            background-color: #e68a00; /* Darker Orange */
            border-color: #e68a0e;
        }

        /* --- Orangish Multi-Level Navigation Styles --- */

        .top-nav, .top-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            background-color: #333333;
        }
        
        /* Main (Level 1) Menu Styling */
        .top-nav {
            display: flex;
            justify-content: flex-start;
            border-bottom: 2px solid #ff9900;
            background: linear-gradient(90deg, #333333 0%, #444444 100%);
        }
        .top-nav > li {
            position: relative;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            align-items: center;
        }
        .top-nav > li:hover {
            background-color: #555555;
            color: white;
        }

        /* Active Menu State (Click) */
        .top-nav > li.show-menu {
            background-color: #ff9900;
            color: #3f3f3f;
        }
        
        /* Icon Styling for Level 1 */
        .top-nav > li::before {
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-right: 8px;
            color: #ffaa33;
        }
        .top-nav > li:hover::before, .top-nav > li.show-menu::before {
            color: #3f3f3f;
        }

        /* Assign specific icons */
        .menu-links::before { content: "\f0ac"; } /* fa-globe */
        .menu-formulas::before { content: "\f128"; } /* fa-flask */
        .menu-trig::before { content: "\f691"; } /* fa-infinity */
        .menu-tools::before { content: "\f7d9"; } /* fa-tools (new) */


        /* Dropdown Menus (Level 2 and deeper) Styling */
        .top-nav ul {
            display: none;
            position: absolute;
            list-style: none;
            min-width: 280px;
            z-index: 1000;
            background-color: #333333;
            border: 1px solid #ff9900;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.7);
        }
        
        /* Level 2 positioning (drops down) */
        .top-nav > li > ul {
            top: 100%;
            left: 0;
        }

        /* Level 3+ positioning (flies out to the right) */
        .top-nav ul ul {
            top: 0;
            left: 100%;
            margin-left: 1px;
        }

        /* !!! KEY CHANGE: Use .show-menu to display !!! */
        .top-nav li.show-menu > ul {
            display: block;
        }

        /* Styling for all list items within the menu structure */
        .top-nav li li {
            position: relative;
            padding: 10px 15px;
            cursor: pointer;
            color: #ccc;
            white-space: nowrap;
            transition: background-color 0.2s;
            border-bottom: 1px solid #4d4d4d;
        }
        .top-nav li li:last-child {
            border-bottom: none;
        }
        .top-nav li li:hover {
            background-color: #555555;
            color: #ffc973;
        }

        /* Anchor link styling */
        .top-nav a {
            color: inherit;
            text-decoration: none;
            display: block;
        }
        
        /* Special style for formula items */
        .formula-item {
            font-weight: 400;
            color: #ffc973;
        }
        .formula-item:hover {
            font-weight: bold;
            background-color: #4d4d4d;
        }

        /* --- Indicator Icon for Sub-Menus --- */
        /* Targets any list item that contains a submenu */
        .top-nav li:has(ul)::after {
            font-family: 'Font Awesome 6 Free';
            content: "\f0da"; /* Right arrow/triangle */
            font-weight: 900;
            position: absolute;
            right: 8px;
            color: #ff9900;
            transition: transform 0.2s;
        }
        /* Rotate the icon when the menu is open (for better visual feedback) */
        .top-nav li.show-menu:has(ul)::after {
            transform: rotate(90deg);
        }
        /* Hide indicator on top-level items (they have specific icons) AND on items that are formulas but contain a list */
        .top-nav > li:has(ul)::after, 
        .top-nav li.formula-item:has(ul)::after {
            content: none;
        }

        /* Modal specific dark mode overrides for background and text */
        .modal-content {
            background-color: #333333;
            color: #ccc;
            border: 1px solid #ff9900;
        }
        .modal-header {
            border-bottom-color: #4d4d4d;
        }
        .modal-footer {
            border-top-color: #4d4d4d;
        }
        .modal-header .close {
            color: #ccc;
            opacity: 1;
        }
        .modal-header .close:hover {
            color: #ff9900;
        }
        /* Style for the visual part of the tool */
        #circleCanvas {
            border: 1px solid #ff9900;
            background-color: #2c2c2c;
            display: block; /* Important for canvas centering and layout */
            margin: 0 auto;
        }
        
    </style>
    <title>Math Input Interface</title>
</head>
<body>
<ul class="top-nav">
    <li class="menu-links">
        External Tools
        <ul>
            <li><a href="https://github.com/AmirTallap/math" target="_blank">Math Proofs Repository</a></li>
            <li><a href="https://www.desmos.com/calculator" target="_blank">Desmos Calculator</a></li>
            <li><a href="https://www.desmos.com/geometry/uvhla17qp3" target="_blank">Desmos Geometry</a></li>
            <li><a href="https://www.desmos.com/3d" target="_blank">Desmos 3D</a></li>
            <li><a href="https://www.wolframalpha.com/" target="_blank">WolframAlpha</a></li>
            <li><a href="https://www.integral-calculator.com/" target="_blank">Integral Calculator</a></li>
        </ul>
    </li>
    <li class="menu-formulas">
        Physics
        <ul>
            <li class="formula-item" data-latex-value="
            $$ a=\frac{\sum F^{\vec{}}}{m} $$
            ">Newton second's law</li>
            <li>
             Kinematic equations
                <ul>
                    <li class="formula-item" data-latex-value="
                    $$ x=v_0t+\frac12at^2 $$
                    $$ a=\frac{dv}{dt},\left(\Delta Velocity\right) $$
                    $$ \int_{v_0}^{v}dv=\int_0^{t}a\,dt,\left(IfAndONLYIFAccelerationIsCONSTANT\right) $$
                    $$ v - v_0 = at $$
                    $$ v = \frac{dx}{dt} $$
                    $$ \frac{dx}{dt} = v_0 + at $$
                    $$ \int_{x_0}^{x} dx = \int_{0}^{t} (v_0 + at) \, dt $$
                    $$ x - x_0 = \left[ v_0t + \frac{1}{2}at^2 \right]_{0}^{t} $$
                    $$ x=x_0+v_0t+\frac{1}{2}at^2\left(CurrentPosition\right) $$
                    ">First two</li>
                    <li class="formula-item" data-latex-value="

                    $$ v-v_0=at\to_{FirstEquationOfMotion} $$
                    $$ x=v_0t+\frac12at^2\to SecondEquationOfMotion $$
                    $$ WeCanSolveFOR->Time $$
                    $$ v-v_0=at $$
                    $$ t=\frac{v-v_0}{a} $$
                    $$ x=v_0\left(\frac{v-v_0}{a}\right)+\frac12a\left(\frac{v-v_0}{a}\right)^2 $$
                    $$ x = \frac{v_0v - v_0^2}{a} + \frac{1}{2}a\left(\frac{v^2 - 2vv_0 + v_0^2}{a^2}\right) $$
                    $$ x = \frac{v_0v - v_0^2}{a} + \frac{v^2 - 2vv_0 + v_0^2}{2a} $$
                    $$ x = \frac{2v_0v - 2v_0^2 + v^2 - 2vv_0 + v_0^2}{2a} $$
                    $$ x = \frac{v^2 - v_0^2}{2a} $$
                    $$ v^2 = v_0^2 + 2ax $$
                    $$ v=\sqrt{v_0^2+2ax},\left(WRONG,DO\right)NOT,DO,IT $$
                    ">Third</li>
                    <li class="formula-item" data-latex-value="
                    $$ v=v_0+at $$
                    $$ {\Delta x}=\left(\dfrac{v+v_0}{2}\right)t $$
                    $$ \Delta x=v_0 t+\dfrac{1}{2}at^2 $$
                    $$ v^2=v_0^2+2a\Delta x $$
                    ">Most used</li>
                    <li class="formula-item" data-latex-value="
                    $$ F_\text{g}=G\dfrac{m_1 m_2}{r^2} $$
                    $$ F_{\text{g}}=\left(G\dfrac{m_1}{r^2}\right)m_2 $$
                    $$ G=6.67\cdot10^{-11}\cdot\frac{m^3}{\operatorname{\mathrm{kg}}.s^2} $$
                    $$ m_1=5.97\cdot10^{24}\operatorname{\mathrm{kg}} $$
                    $$ r=6,370,000m $$
                    $$ F_\text{g}=\left(\color{blue}{G}\dfrac{\color{red}{m_1}}{\color{green}{r}^{\color{black}{2}}}\color{black}\right)m_2 $$
                    $$ F_\text{g}=\left(\color{blue}{\left(6.67\times10^{-11}\space\frac{\text{m}^{\cancel{3}}}{\cancel{\text{kg}}\:\cdot\:\text{s}^2}\right)}\dfrac{\color{red}{(5.97\times10^{24}\space\cancel{\text{kg}})}}{\color{green}{(6{,}370{,}000\space\cancel{\text{m}})}^{\color{black}{2}}}\color{black}\right)m_2 $$
                    $$ \left(\color{blue}{\left(6.67\times10^{-11}\right)}\dfrac{\color{red}{(5.97\times10^{24})}}{\color{green}{(6{,}370{,}000)}^{\color{black}{2}}}\color{black}\right)=9.81 $$
                    ">Earth gravity</li>
                </ul>
            </li>
            <li class="formula-item" data-latex-value="
        $$ \vec{p}=m\vec{v} $$
        $$ \Delta\vec{p}=\vec{p}_{\text{\,f}}-\vec{p}_{\text{\,i}} $$
        $$ \Delta\vec{p}=\Sigma\vec{F}\Delta t $$
            ">Impulse & Momentum</li>
        </ul>
    </li>
    <li class="menu-formulas">
        Algebra
        <ul>
            <li>
                Quadratic & Polynomials
                <ul>
                    <li class="formula-item" data-latex-value="$$ x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a} $$">Quadratic Formula</li>
                    <li class="formula-item" data-latex-value="$$ ax^2 + bx + c = a(x - r_1)(x - r_2) $$">Factored Form (Roots)</li>
                    <li class="formula-item" data-latex-value="$$ (a+b)^2 = a^2 + 2ab + b^2 $$">Binomial Square</li>
                    <li class="formula-item" data-latex-value="$$ (a-b)^2 = a^2 - 2ab + b^2 $$">Binomial Square (Difference)</li>
                    <li class="formula-item" data-latex-value="$$ a^2 - b^2 = (a-b)(a+b) $$">Difference of Squares</li>
                    <li class="formula-item" data-latex-value="$$ a^3 + b^3 = (a+b)(a^2 - ab + b^2) $$">Sum of Cubes</li>
                    <li class="formula-item" data-latex-value="$$ a^3 - b^3 = (a-b)(a^2 + ab + b^2) $$">Difference of Cubes</li>
                    <li class="formula-item" data-latex-value="$$ (a+b)^3 = a^3 + 3a^2b + 3ab^2 + b^3 $$">Binomial Cube</li>
                </ul>
            </li>
            <li>
                Exponents & Logarithms
                <ul>
                    <li class="formula-item" data-latex-value="$$ a^m \cdot a^n = a^{m+n} $$">Product Rule</li>
                    <li class="formula-item" data-latex-value="$$ \frac{a^m}{a^n} = a^{m-n} $$">Quotient Rule</li>
                    <li class="formula-item" data-latex-value="$$ (a^m)^n = a^{mn} $$">Power of a Power</li>
                    <li class="formula-item" data-latex-value="$$ \log_b(xy) = \log_b x + \log_b y $$">Log Product Rule</li>
                    <li class="formula-item" data-latex-value="$$ \log_b\left(\frac{x}{y}\right) = \log_b x - \log_b y $$">Log Quotient Rule</li>
                    <li class="formula-item" data-latex-value="$$ \log_b(x^n) = n \log_b x $$">Log Power Rule</li>
                    <li class="formula-item" data-latex-value="$$ \log_b x = \frac{\ln x}{\ln b} $$">Change of Base Formula</li>
                </ul>
            </li>
        </ul>
    </li>

    <li class="menu-formulas">
        Differential Calculus
        <ul>
            <li>
                Derivative Rules
                <ul>
                    <li class="formula-item" data-latex-value="$$ \frac{d}{dx}[c] = 0 $$">Constant Rule</li>
                    <li class="formula-item" data-latex-value="$$ \frac{d}{dx}[x^n] = n x^{n-1} $$">Power Rule</li>
                    <li class="formula-item" data-latex-value="$$ \frac{d}{dx}[e^x] = e^x $$">Exponential (e^x)</li>
                    <li class="formula-item" data-latex-value="$$ \frac{d}{dx}[a^x] = a^x \ln a $$">Exponential (a^x)</li>
                    <li class="formula-item" data-latex-value="$$ \frac{d}{dx}[\ln x] = \frac{1}{x} $$">Natural Log</li>
                    <li class="formula-item" data-latex-value="$$ \frac{d}{dx}[\sin x] = \cos x $$">Sine</li>
                    <li class="formula-item" data-latex-value="$$ \frac{d}{dx}[\cos x] = -\sin x $$">Cosine</li>
                    <li class="formula-item" data-latex-value="$$ \frac{d}{dx}[\tan x] = \sec^2 x $$">Tangent</li>
                </ul>
            </li>
            <li>
                Derivative Techniques
                <ul>
                    <li class="formula-item" data-latex-value="$$ \frac{d}{dx}[f(x)g(x)] = f'(x)g(x) + f(x)g'(x) $$">Product Rule</li>
                    <li class="formula-item" data-latex-value="$$ \frac{d}{dx}\left[\frac{f(x)}{g(x)}\right] = \frac{g(x)f'(x) - f(x)g'(x)}{[g(x)]^2} $$">Quotient Rule</li>
                    <li class="formula-item" data-latex-value="$$ y^{\prime}=f^{\prime}(g(x))\cdot g^{\prime}(x) $$">Chain Rule</li>
                    <li class="formula-item" data-latex-value="$$ \frac{dy}{dx} = \frac{dy/dt}{dx/dt} $$">Parametric Derivative</li>
                    <li class="formula-item" data-latex-value="$$ \frac{dy}{dx} = -\frac{F_x}{F_y} $$">Implicit Differentiation</li>
                </ul>
            </li>
            <li>
                Applications
                <ul>
                    <li class="formula-item" data-latex-value="$$ f'(x) = \lim_{h \to 0} \frac{f(x+h)-f(x)}{h} $$">Limit Definition</li>
                    <li class="formula-item" data-latex-value="$$ L(x) = f(a) + f'(a)(x-a) $$">Linear Approximation</li>
                    <li class="formula-item" data-latex-value="$$ \frac{d^2y}{dx^2} = \frac{d}{dx}\left(\frac{dy}{dx}\right) $$">Second Derivative</li>
                </ul>
            </li>
        </ul>
    </li>

    <li class="menu-formulas">
        Integral Calculus
        <ul>
            <li>
                Fundamental Theorems
                <ul>
                    <li class="formula-item" data-latex-value="$$ \frac{d}{dx} \int_a^x f(t) \, dt = f(x) $$">FTC Part I</li>
                    <li class="formula-item" data-latex-value="$$ \int_a^b f(x) \, dx = F(b) - F(a) $$">FTC Part II</li>
                </ul>
            </li>
            <li>
                Basic Integrals
                <ul>
                    <li class="formula-item" data-latex-value="$$ \int x^n \, dx = \frac{x^{n+1}}{n+1} + C, \quad n \neq -1 $$">Power Rule</li>
                    <li class="formula-item" data-latex-value="$$ \int \frac{1}{x} \, dx = \ln|x| + C $$">Integral of 1/x</li>
                    <li class="formula-item" data-latex-value="$$ \int e^x \, dx = e^x + C $$">Exponential (e^x)</li>
                    <li class="formula-item" data-latex-value="$$ \int a^x \, dx = \frac{a^x}{\ln a} + C $$">Exponential (a^x)</li>
                </ul>
            </li>
            <li>
                Trigonometric Integrals
                <ul>
                    <li class="formula-item" data-latex-value="$$ \int \sin x \, dx = -\cos x + C $$">Sine</li>
                    <li class="formula-item" data-latex-value="$$ \int \cos x \, dx = \sin x + C $$">Cosine</li>
                    <li class="formula-item" data-latex-value="$$ \int \sec^2 x \, dx = \tan x + C $$">Secant Squared</li>
                    <li class="formula-item" data-latex-value="$$ \int \sec x \tan x \, dx = \sec x + C $$">Secant-Tangent</li>
                    <li class="formula-item" data-latex-value="$$ \int \csc^2 x \, dx = -\cot x + C $$">Cosecant Squared</li>
                    <li class="formula-item" data-latex-value="$$ \int \csc x \cot x \, dx = -\csc x + C $$">Cosecant-Cotangent</li>
                </ul>
            </li>
            <li>
                Integration Techniques
                <ul>
                    <li class="formula-item" data-latex-value="$$ \int u \, dv = uv - \int v \, du $$">Integration by Parts</li>
                    <li>
                        Trigonometric Substitution
                        <ul>
                            <li class="formula-item" 
                                data-latex-value="
                                    $$ \sqrt{a^2 - x^2} \Rightarrow x = a\sin\theta $$
                                    $$ \sqrt{a^2 + x^2} \Rightarrow x = a\tan\theta $$
                                    $$ \sqrt{x^2 - a^2} \Rightarrow x = a\sec\theta $$
                                ">Three Cases</li>
                        </ul>
                    </li>
                    <li class="formula-item" data-latex-value="$$ \int \frac{dx}{a^2 + x^2} = \frac{1}{a} \arctan\left(\frac{x}{a}\right) + C $$">Arctan Integral</li>
                    <li class="formula-item" data-latex-value="$$ \int \frac{dx}{\sqrt{a^2 - x^2}} = \arcsin\left(\frac{x}{a}\right) + C $$">Arcsin Integral</li>
                </ul>
            </li>
            <li>
                Application of integrals
                <ul>
                    <li>
                        Volume Calculations
                        <ul>
                            <li class="formula-item" 
                                data-latex-value="
                                    $$ Area=\pi r^2 $$
                                    $$ AreaIsSolid\left(NoHole\right) $$
                                    $$ RotationAroundThe\left(x\right)Axis,Or\left(y\right)=k $$
                                    $$ V=\pi\int_{a}^{b}[f(x)]^2\,dx $$
                                    $$ RotationAroundThe\left(y\right)Axis,Or\left(x\right)=h $$
                                    $$ V = \pi \int_{c}^{d} [g(y)]^2 \, dy $$
                                ">The Disk Method</li>


                                <li class="formula-item" 
                                data-latex-value="
                                    $$ AreaHasAHollow\mathbb{C}ORE,R_{outer}-R_{InNer} $$
                                    $$ V=\left(\pi R^2-\pi r^2\right) $$
                                    $$ Around\left(X\right)Axis\left(\differentialD x\right) $$
                                    $$ V = \pi \int_{a}^{b} \left( [R(x)]^2 - [r(x)]^2 \right) \, dx $$
                                    $$ Around\left(Y\right)Axis\left(\differentialD y\right) $$
                                    $$ V = \pi \int_{c}^{d} \left( [R(y)]^2 - [r(y)]^2 \right) \, dy $$
                                ">The Washer Method</li>

                                <li class="formula-item" 
                                data-latex-value="
                                    $$ Ù\text{Rotation around y-axis (using }dx\text{)} $$
                                    $$ V = 2\pi \int_{a}^{b} (x) \cdot |f(x)| \, dx $$
                                    $$ \text{Rotation around x-axis (using }dy\text{)} $$
                                    $$ V = 2\pi \int_{c}^{d} (y) \cdot |g(y)| \, dy $$
                                ">The Shell Method</li>
                        </ul>
                    </li>
                    <li>
                        Arc calculation
                        <ul>
                            <li class="formula-item" 
                                data-latex-value="
                                    $$ ArcLeng\operatorname{\mathrm{th}}\left(UseWhenYouNeedTheExactArcLeng\operatorname{\mathrm{th}}\right) $$
                                    $$ Derived from the Pythagorean theorem ($a^2 + b^2 = c^2$) $$
                                    $$ If\left(y=f(x)\right) $$
                                    $$ L = \int_{a}^{b} \sqrt{1 + \left[ f'(x) \right]^2} \, dx $$
                                    $$ If\left(x=g(y)\right) $$
                                    $$ L = \int_{c}^{d} \sqrt{1 + \left[ g'(y) \right]^2} \, dy $$
                                ">Arc Length</li>

                            <li class="formula-item" 
                                data-latex-value="
                                    $$ \displaystyle\int_a^b\sqrt{\left(\dfrac{dx}{dt}\right)^2+\left(\dfrac{dy}{dt}\right)^2}\, dt $$
                                    $$ {\Delta s}\approx\sqrt{({\Delta x})^2+({\Delta y})^2} $$
                                    $$ {\displaystyle\int_{a}^{b}\sqrt{\left({\dfrac{dx}{dt}}\right)^2+\left({\dfrac{dy}{dt}}\right)^2}\,dt} $$
                                ">Parametric curve arc length</li>
                        </ul>
                    </li>
                </ul>
            </li>
        </ul>
    </li>

    <li class="menu-formulas">
        Limits & Series
        <ul>
            <li>
                Limit Rules
                <ul>
                    <li class="formula-item" data-latex-value="$$ \lim_{x \to a} [f(x) \pm g(x)] = \lim_{x \to a} f(x) \pm \lim_{x \to a} g(x) $$">Sum/Difference</li>
                    <li class="formula-item" data-latex-value="$$ \lim_{x \to a} \frac{f(x)}{g(x)} = \frac{\lim_{x \to a} f(x)}{\lim_{x \to a} g(x)}, \quad \text{if } \lim_{x \to a} g(x) \neq 0 $$">Quotient Rule</li>
                    <li class="formula-item" data-latex-value="$$ \lim_{x \to 0} \frac{\sin x}{x} = 1 $$">Sine Limit</li>
                    <li class="formula-item" data-latex-value="$$ \lim_{x \to 0} \frac{1 - \cos x}{x} = 0 $$">Cosine Limit</li>
                </ul>
            </li>
            <li>
                L'HÃ´pital's Rule
                <ul>
                    <li class="formula-item" data-latex-value="$$ \lim_{x \to a} \frac{f(x)}{g(x)} = \lim_{x \to a} \frac{f'(x)}{g'(x)} \quad \text{if } \frac{0}{0} \text{ or } \frac{\infty}{\infty} $$">Basic Form</li>
                </ul>
            </li>
            <li>
                Series Expansions
                <ul>
                    <li class="formula-item" data-latex-value="$$ e^x = \sum_{n=0}^{\infty} \frac{x^n}{n!} $$">Exponential</li>
                    <li class="formula-item" data-latex-value="$$ \sin x = \sum_{n=0}^{\infty} \frac{(-1)^n x^{2n+1}}{(2n+1)!} $$">Sine</li>
                    <li class="formula-item" data-latex-value="$$ \cos x = \sum_{n=0}^{\infty} \frac{(-1)^n x^{2n}}{(2n)!} $$">Cosine</li>
                    <li class="formula-item" data-latex-value="$$ \frac{1}{1-x} = \sum_{n=0}^{\infty} x^n, \quad |x| < 1 $$">Geometric</li>
                </ul>
            </li>
        </ul>
    </li>

    <li class="menu-formulas">
        Multivariable Calculus
        <ul>
            <li>
                Partial Derivatives
                <ul>
                    <li class="formula-item" data-latex-value="$$ f_x = \frac{\partial f}{\partial x} = \lim_{h \to 0} \frac{f(x+h,y)-f(x,y)}{h} $$">Definition</li>
                    <li class="formula-item" data-latex-value="$$ \frac{\partial}{\partial x}(uv) = u_x v + u v_x $$">Product Rule</li>
                </ul>
            </li>
            <li>
                Gradient & Directional Derivative
                <ul>
                    <li class="formula-item" data-latex-value="$$ \nabla f = \left\langle \frac{\partial f}{\partial x}, \frac{\partial f}{\partial y} \right\rangle $$">Gradient</li>
                    <li class="formula-item" data-latex-value="$$ D_{\mathbf{u}} f = \nabla f \cdot \mathbf{u} $$">Directional Derivative</li>
                </ul>
            </li>
            <li>
                Multiple Integrals
                <ul>
                    <li class="formula-item" data-latex-value="$$ \iint_R f(x,y) \, dA $$">Double Integral</li>
                    <li class="formula-item" data-latex-value="$$ \iiint_D f(x,y,z) \, dV $$">Triple Integral</li>
                    <li class="formula-item" data-latex-value="$$ \iint_R f(x,y) \, dA = \int_a^b \int_{g_1(x)}^{g_2(x)} f(x,y) \, dy \, dx $$">Iterated Form</li>
                </ul>
            </li>
        </ul>
    </li>

    <li class="menu-trig">
        Trigonometry
        <ul>
            <li>
                Pythagorean Identities
                <ul>
                    <li class="formula-item" data-latex-value="$$ \sin^2\theta + \cos^2\theta = 1 $$">Basic</li>
                    <li class="formula-item" data-latex-value="$$ 1 + \tan^2\theta = \sec^2\theta $$">With Tangent</li>
                    <li class="formula-item" data-latex-value="$$ 1 + \cot^2\theta = \csc^2\theta $$">With Cotangent</li>
                </ul>
            </li>
            <li>
                Angle Sum/Difference
                <ul>
                    <li class="formula-item" data-latex-value="$$ \sin(A \pm B) = \sin A \cos B \pm \cos A \sin B $$">Sine</li>
                    <li class="formula-item" data-latex-value="$$ \cos(A \pm B) = \cos A \cos B \mp \sin A \sin B $$">Cosine</li>
                    <li class="formula-item" data-latex-value="$$ \tan(A \pm B) = \frac{\tan A \pm \tan B}{1 \mp \tan A \tan B} $$">Tangent</li>
                </ul>
            </li>
            <li>
                Double Angle
                <ul>
                    <li class="formula-item" data-latex-value="$$ \sin 2\theta = 2\sin\theta\cos\theta $$">Sine</li>
                    <li class="formula-item" data-latex-value="$$ \cos 2\theta = \cos^2\theta - \sin^2\theta $$">Cosine (Form 1)</li>
                    <li class="formula-item" data-latex-value="$$ \cos 2\theta = 2\cos^2\theta - 1 $$">Cosine (Form 2)</li>
                    <li class="formula-item" data-latex-value="$$ \cos 2\theta = 1 - 2\sin^2\theta $$">Cosine (Form 3)</li>
                    <li class="formula-item" data-latex-value="$$ \tan 2\theta = \frac{2\tan\theta}{1 - \tan^2\theta} $$">Tangent</li>
                </ul>
            </li>
            <li>
                Half Angle
                <ul>
                    <li class="formula-item" data-latex-value="$$ \sin\left(\frac{\theta}{2}\right) = \pm\sqrt{\frac{1 - \cos\theta}{2}} $$">Sine</li>
                    <li class="formula-item" data-latex-value="$$ \cos\left(\frac{\theta}{2}\right) = \pm\sqrt{\frac{1 + \cos\theta}{2}} $$">Cosine</li>
                    <li class="formula-item" data-latex-value="$$ \tan\left(\frac{\theta}{2}\right) = \frac{1 - \cos\theta}{\sin\theta} = \frac{\sin\theta}{1 + \cos\theta} $$">Tangent</li>
                </ul>
            </li>
        </ul>
    </li>

    <li class="menu-formulas">
        Geometry & Vectors
        <ul>
            <li>
                Planar Geometry
                <ul>
                    <li class="formula-item" data-latex-value="$$ A_{\text{circle}} = \pi r^2 $$">Circle Area</li>
                    <li class="formula-item" data-latex-value="$$ C_{\text{circle}} = 2\pi r $$">Circumference</li>
                    <li class="formula-item" data-latex-value="$$ A_{\text{triangle}} = \frac{1}{2}bh $$">Triangle Area</li>
                    <li class="formula-item" data-latex-value="$$ A_{\text{triangle}} = \frac{1}{2}ab\sin C $$">Triangle Area (SAS)</li>
                    <li class="formula-item" data-latex-value="$$ c^2 = a^2 + b^2 - 2ab\cos C $$">Law of Cosines</li>
                    <li class="formula-item" data-latex-value="$$ \frac{a}{\sin A} = \frac{b}{\sin B} = \frac{c}{\sin C} $$">Law of Sines</li>
                </ul>
            </li>
            <li>
                Coordinate Geometry
                <ul>
                    <li class="formula-item" data-latex-value="$$ d = \sqrt{(x_2-x_1)^2 + (y_2-y_1)^2} $$">Distance Formula</li>
                    <li class="formula-item" data-latex-value="$$ m = \frac{y_2 - y_1}{x_2 - x_1} $$">Slope</li>
                    <li class="formula-item" data-latex-value="$$ y - y_1 = m(x - x_1) $$">Point-Slope Form</li>
                    <li class="formula-item" data-latex-value="$$ Ax + By + C = 0 $$">General Line Equation</li>
                </ul>
            </li>
            <li>
                Vectors
                <ul>
                    <li class="formula-item" data-latex-value="$$ \mathbf{a} \cdot \mathbf{b} = a_1b_1 + a_2b_2 + a_3b_3 $$">Dot Product</li>
                    <li class="formula-item" data-latex-value="$$ \mathbf{a} \times \mathbf{b} = \begin{vmatrix} \mathbf{i} & \mathbf{j} & \mathbf{k} \\ a_1 & a_2 & a_3 \\ b_1 & b_2 & b_3 \end{vmatrix} $$">Cross Product</li>
                    <li class="formula-item" data-latex-value="$$ \|\mathbf{a}\| = \sqrt{a_1^2 + a_2^2 + a_3^2} $$">Magnitude</li>
                </ul>
            </li>
        </ul>
    </li>

    <li class="menu-formulas">
        Differential Equations
        <ul>
            <li>
                First Order
                <ul>
                    <li class="formula-item" data-latex-value="$$ \frac{dy}{dx} = f(x)g(y) \Rightarrow \int \frac{dy}{g(y)} = \int f(x) \, dx $$">Separable</li>
                    <li class="formula-item" data-latex-value="$$ \frac{dy}{dx} + P(x)y = Q(x) $$">Linear Form</li>
                    <li class="formula-item" data-latex-value="$$ y = e^{-\int P \, dx} \left[ \int Q e^{\int P \, dx} \, dx + C \right] $$">Integrating Factor</li>
                </ul>
            </li>
            <li>
                Second Order Linear
                <ul>
                    <li class="formula-item" data-latex-value="$$ ay'' + by' + cy = 0 $$">Homogeneous</li>
                    <li class="formula-item" data-latex-value="$$ ar^2 + br + c = 0 $$">Characteristic Equation</li>
                </ul>
            </li>
        </ul>
    </li>

    <li class="menu-formulas">
        Linear Algebra
        <ul>
            <li>
                Matrices
                <ul>
                    <li class="formula-item" data-latex-value="$$ \det\begin{pmatrix} a & b \\ c & d \end{pmatrix} = ad - bc $$">2x2 Determinant</li>
                    <li class="formula-item" data-latex-value="$$ A^{-1} = \frac{1}{\det(A)} \text{adj}(A) $$">Inverse Formula</li>
                    <li class="formula-item" data-latex-value="$$ A\mathbf{x} = \mathbf{b} \Rightarrow \mathbf{x} = A^{-1}\mathbf{b} $$">System Solution</li>
                </ul>
            </li>
            <li>
                Eigenvalues
                <ul>
                    <li class="formula-item" data-latex-value="$$ \det(A - \lambda I) = 0 $$">Characteristic Polynomial</li>
                </ul>
            </li>
        </ul>
    </li>

    <li class="menu-formulas">
        Advanced & Useful
        <ul>
            <li class="formula-item" data-latex-value="
                $$ ~\Delta x=StepSize $$
                $$ \Delta y_{n}=f^{}^{\prime}(x_{n},y_{n})\cdot\Delta x $$
                $$ y_{n+1} = y_n + \Delta y_n $$   
            ">Euler's method</li>
            <li class="formula-item" data-latex-value="$$ e^{i\theta} = \cos\theta + i\sin\theta $$">Euler's Formula</li>
            <li class="formula-item" data-latex-value="$$ e^{i\pi} + 1 = 0 $$">Euler's Identity</li>
            <li class="formula-item" data-latex-value="$$ \frac{d}{dx}[f^{-1}(x)] = \frac{1}{f'(f^{-1}(x))} $$">Derivative of Inverse</li>
            <li class="formula-item" data-latex-value="$$ \int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi} $$">Gaussian Integral</li>
            <li class="formula-item" data-latex-value="$$ \Gamma(n) = (n-1)! $$">Gamma Function (Integer)</li>
        </ul>
    </li>

    <li class="menu-formulas">
        Problem-Solving Strategies
        <ul>
            <li>
                Integration Guide
                <ul>
                    <li class="formula-item" data-latex-value="$$
\begin{array}{|c|c|}
\hline
\text{Form} & \text{Technique} \\
\hline
\int f(ax+b) \, dx & \text{Simple substitution} \\
\int x^n e^x \, dx & \text{Integration by parts} \\
\int \frac{p(x)}{q(x)} \, dx & \text{Partial fractions} \\
\int \sqrt{a^2-x^2} \, dx & \text{Trig substitution} \\
\hline
\end{array}
$$">Technique Selection</li>
                </ul>
            </li>
            <li>
                Common Checks
                <ul>
                    <li class="formula-item" data-latex-value="$$ \text{Derivative Check: } \frac{d}{dx} \left[ \int f(x) \, dx \right] = f(x) $$">Antiderivative Verification</li>
                    <li class="formula-item" data-latex-value="$$ \text{Domain: } \sqrt{x} \Rightarrow x \geq 0, \quad \ln(x) \Rightarrow x > 0 $$">Domain Restrictions</li>
                </ul>
            </li>
            <li>
                Symmetry Exploitation
                <ul>
                    <li class="formula-item" data-latex-value="$$ \int_{-a}^a f(x) \, dx = \begin{cases} 0 & \text{if } f \text{ is odd} \\ 2\int_0^a f(x) \, dx & \text{if } f \text{ is even} \end{cases} $$">Even/Odd Functions</li>
                </ul>
            </li>
        </ul>
    </li>

    <li class="menu-formulas">
        Theorem Proving
        <ul>
            <li class="formula-item" 
                data-latex-value="
                    $$ \sin(A+B) = \sin A \cos B + \cos A \sin B $$
                    $$ \text{Let } A = x \text{ and } B = x $$
                    $$ \sin(x+x) = \sin x \cos x + \cos x \sin x $$
                    $$ \sin(2x) = 2\sin x \cos x $$
                ">
                Proof: Sine Double Angle
            </li>
            <li class="formula-item" 
                data-latex-value="
                    $$ \int u \, dv = uv - \int v \, du $$
                    $$ \text{Choose } u = x \text{ and } dv = e^x \, dx $$
                    $$ \text{Then } du = dx \text{ and } v = e^x $$
                    $$ \int x e^x \, dx = x e^x - \int e^x \, dx $$
                    $$ \int x e^x \, dx = x e^x - e^x + C $$
                ">
                Proof: Integration by Parts Example 1
            </li>
            <li class="formula-item" 
                data-latex-value="
                    $$ \frac{d}{dx}[f(x)g(x)] = f'(x)g(x) + f(x)g'(x) $$
                    $$ f(x)g(x) = \int f'(x)g(x) \, dx + \int f(x)g'(x) \, dx $$
                    $$ \int f(x)g'(x) \, dx = f(x)g(x) - \int f'(x)g(x) \, dx $$
                ">
                Proof: Integration by Parts from Product Rule
            </li>
        </ul>
    </li>

    <li class="menu-tools">
        Interactive Tools
        <ul>
            <li data-toggle="modal" data-target="#circleSplitterModal">Circle Splitter</li>
            <li data-toggle="modal" data-target="#triangleSolverModal">Right Triangle Solver</li>
            <li data-toggle="modal" data-target="#formulaReferenceModal">Formula Reference</li>
            <li data-toggle="modal" data-target="#graphingToolModal">Graphing Tool</li>
            <li data-toggle="modal" data-target="#integratorToolModal">Integrator Tool</li>
            <li data-toggle="modal" data-target="#matrixCalculatorModal">Matrix Calculator</li>
        </ul>
    </li>
</ul>
    <div class="container-fluid text-center mathInputs mt-3">
        <div class="row align-items-center mb-2">
            <div class="d-flex w-100">
                <math-field class="custom-math-field flex-grow-1"></math-field>
                <button type="button" class="btn btn-outline-danger btn-sm ml-2 clearButton flex-shrink-0">Remove</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-6 mt-5">
                <button type="button" class="btn btn-outline-primary btn-block copyAll copy-all-btn">Copy All</button>
            </div>
            <div class="col-6 mt-5">
                <button type="button" class="btn btn-outline-primary btn-block clearAll">Clear</button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="circleSplitterModal" tabindex="-1" role="dialog" aria-labelledby="circleSplitterModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="circleSplitterModalLabel">Circle Splitter Tool</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="row">
                <div class="col-md-4">
                    <label for="splitSegments">Number of Equal Segments:</label>
                    <input type="number" id="splitSegments" class="form-control mb-3" min="1" max="360" value="4">
                    
                    <button class="btn btn-block copy-all-btn" id="calculateCircleSplit">Calculate Angle</button>
                    
                    <h5 class="mt-4">Results</h5>
                    <div id="circleResults" class="p-2 border rounded" style="word-break: break-all;">
                        Angle per segment: **90Â°**
                    </div>
                    <button class="btn btn-sm copy-all-btn mt-2" id="copyAngleLatex">Copy LaTeX</button>
                </div>
                <div class="col-md-8 text-center">
                    <canvas id="circleCanvas" width="300" height="300"></canvas>
                </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="triangleSolverModal" tabindex="-1" role="dialog" aria-labelledby="triangleSolverModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="triangleSolverModalLabel">Right Triangle Solver</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>This tool is coming next!</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <script defer src="https://cdn.jsdelivr.net/npm/mathlive"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Re-define the HTML for a new math field row
            const mathElement = `
            <div class="row align-items-center mb-2">
                <div class="d-flex w-100">
                    <math-field class="custom-math-field flex-grow-1"></math-field>
                    <button type="button" class="btn btn-outline-danger btn-sm ml-2 clearButton flex-shrink-0">Remove</button>
                </div>
            </div>`;

            const mathInputsContainer = document.querySelector('.mathInputs');
            const clearAllButton = document.querySelector('.clearAll');
            const copyAllButton = document.querySelector('.copyAll');
            const topNav = document.querySelector('.top-nav');

            /* --- Math Field Insertion Logic (Your working function) --- */
            function addNewMathFieldWithLatex(latexValue = '') {
                // Regex: Find $$ (group 1: non-greedy content) $$ - using 's' flag for newlines
                const regex = /\$\$(.*?)\$\$/gs;
                let match;
                const formulaBlocks = [];

                // Use exec() in a loop to extract all captured content (Group 1)
                while ((match = regex.exec(latexValue)) !== null) {
                    // match[1] contains the clean content captured inside the (.*?) group
                    formulaBlocks.push(match[1].trim());
                }

                // Fallback for an empty click
                if (formulaBlocks.length === 0) {
                    mathInputsContainer.insertAdjacentHTML('beforeend', mathElement);
                    const newField = document.querySelector('.mathInputs .custom-math-field:last-child');
                    if (newField) newField.focus();
                    return;
                }
                
                // Use the proven insertion method for each extracted formula
                formulaBlocks.forEach(cleanLatex => {
                    // 1. Add the new field HTML to the DOM
                    mathInputsContainer.insertAdjacentHTML('beforeend', mathElement);

                    // 2. Get the new field reference
                    const newFields = document.querySelectorAll('.custom-math-field');
                    const newField = newFields[newFields.length - 1];
                    if (!newField) return; // safety check
                    
                    // 3. Populate
                    newField.value = cleanLatex;

                    // 4. Focus and scroll
                    newField.focus();
                    newField.scrollIntoView({ behavior: 'smooth', block: 'end' });
                });
            }

            /* --- Menu Activation & Closing Logic --- */

            /** Closes all open menus at any level. */
            function closeAllMenus() {
                document.querySelectorAll('.top-nav li.show-menu').forEach(li => {
                    li.classList.remove('show-menu');
                });
            }

            // 1. Handle Menu Clicks (Open/Close Parent Menus)
            topNav.addEventListener('click', function(event) {
                const targetLi = event.target.closest('.top-nav > li');
                const clickedFormulaItem = event.target.closest('li.formula-item');
                const clickedParentLi = event.target.closest('.top-nav li');
                const clickedToolItem = event.target.closest('.menu-tools li'); // NEW: Tool item check

                if (clickedFormulaItem) {
                    // If a formula is clicked, process it, then close all menus
                    const latexValue = clickedFormulaItem.getAttribute('data-latex-value');
                    if (latexValue) {
                        addNewMathFieldWithLatex(latexValue);
                    }
                    closeAllMenus();
                    return;
                }
                
                if (clickedToolItem) {
                    // If a tool is clicked, let Bootstrap handle the modal trigger, then close the menu
                    closeAllMenus();
                    // We rely on data-toggle and data-target attributes in the HTML for opening the modal.
                    return;
                }

                // Check if the click was on a parent list item that contains a submenu
                if (clickedParentLi && clickedParentLi.querySelector('ul')) {
                    event.stopPropagation(); // Prevent the document click listener from firing immediately

                    const isCurrentlyOpen = clickedParentLi.classList.contains('show-menu');

                    // If it's a top-level parent (Level 1), close all others first
                    if (targetLi === clickedParentLi) {
                        closeAllMenus();
                    }
                    
                    // Toggle the 'show-menu' class on the clicked list item
                    clickedParentLi.classList.toggle('show-menu');
                } else if (clickedParentLi) {
                    // If a simple link/item is clicked, close all menus
                    closeAllMenus();
                }
            });

            // 2. Handle Off-Click Closing
            document.addEventListener('click', function(event) {
                // If the click is outside the entire top-nav, close all menus
                if (!event.target.closest('.top-nav')) {
                    closeAllMenus();
                }
            });
    
            // --- Input Field and Enter Key Logic (No change needed) ---
            document.addEventListener('keydown', function(event) {
                const activeElement = document.activeElement;
                const isInsideSpecificInput = activeElement.classList.contains('custom-math-field');
                if (event.key === 'Enter' && isInsideSpecificInput) {
                    event.preventDefault();
                    const fields = Array.from(document.querySelectorAll('.custom-math-field'));
                    const index = fields.indexOf(activeElement);
                    if (index === fields.length - 1) {
                        addNewMathFieldWithLatex();
                    } else {
                        fields[index + 1].focus();
                    }
                }
            });
    
            // --- Remove/Clear/Copy Logic (No change needed) ---
            mathInputsContainer.addEventListener('click', function (event) {
                if (event.target.classList.contains('clearButton')) {
                    const row = event.target.closest('.row');
                    if (row) {
                        row.remove();
                        const remainingFields = mathInputsContainer.querySelectorAll('.custom-math-field');
                        if (remainingFields.length === 0) {
                            clearAllButton.click();
                        }
                    }
                }
            });
    
            clearAllButton.addEventListener('click', function () {
                mathInputsContainer.innerHTML = '';
                addNewMathFieldWithLatex();
            });

            copyAllButton.addEventListener('click', async function () {
                const fields = document.querySelectorAll('.custom-math-field');
                let allContent = [];

                fields.forEach(field => {
                    const content = field.getValue().trim();
                    if (content) {
                        allContent.push(`$$ ${content} $$`);
                    }
                });

                const contentToCopy = allContent.join("\n");
                if (contentToCopy) {
                    try {
                        await navigator.clipboard.writeText(contentToCopy);
                        copyAllButton.textContent = 'Copied! ðŸŽ‰';
                        setTimeout(() => { copyAllButton.textContent = 'Copy All'; }, 1500);
                    } catch (err) {
                        console.error('Could not copy text: ', err);
                        copyAllButton.textContent = 'Failed! ðŸ˜¢';
                        setTimeout(() => { copyAllButton.textContent = 'Copy All'; }, 1500);
                    }
                } else {
                    copyAllButton.textContent = 'Empty! ðŸ§';
                    setTimeout(() => { copyAllButton.textContent = 'Copy All'; }, 1500);
                }
            });


            /* --- NEW: Circle Splitter Tool Logic (Phase 2) --- */

            const canvas = document.getElementById('circleCanvas');
            const ctx = canvas.getContext('2d');
            const segmentInput = document.getElementById('splitSegments');
            const resultsDiv = document.getElementById('circleResults');
            const calculateButton = document.getElementById('calculateCircleSplit');
            const copyAngleLatexButton = document.getElementById('copyAngleLatex');

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 120;
            const TWO_PI = 2 * Math.PI;

            /** Draws the circle and its segments based on the input value. */
            function drawCircle(segments) {
                // Clear the canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Draw the main circle
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, TWO_PI);
                ctx.strokeStyle = '#cccccc';
                ctx.lineWidth = 2;
                ctx.stroke();

                if (segments > 0) {
                    const anglePerSegment = TWO_PI / segments;
                    
                    // Draw segments
                    ctx.strokeStyle = '#ff9900';
                    ctx.lineWidth = 1;
                    for (let i = 0; i < segments; i++) {
                        const startAngle = i * anglePerSegment;
                        
                        ctx.beginPath();
                        ctx.moveTo(centerX, centerY);
                        // Draw line from center to the edge of the circle
                        ctx.lineTo(
                            centerX + radius * Math.cos(startAngle),
                            centerY + radius * Math.sin(startAngle)
                        );
                        ctx.stroke();
                    }
                }
            }
            
            /** Calculates the angle and updates the result text. */
            function updateCircleSplit() {
                let segments = parseInt(segmentInput.value, 10);
                
                // Sanitize input
                if (isNaN(segments) || segments < 1) {
                    segments = 1;
                    segmentInput.value = 1;
                }
                
                const angle = 360 / segments;
                const radians = TWO_PI / segments;

                // Update visual
                drawCircle(segments);

                // Update text results
                let resultText = `Angle per segment: **${angle}Â°**`;
                let latexOutput = `$$ \\text{Angle} = \\frac{360^{\\circ}}{${segments}} = ${angle}^{\\circ} $$`;

                if (segments !== 1) {
                    resultText += `<br>Angle in radians: **${radians.toFixed(4)}** rad`;
                    latexOutput += `\n$$ \\text{Radians} = \\frac{2\\pi}{${segments}} = ${radians.toFixed(4)} $$`;
                }

                resultsDiv.innerHTML = resultText;
                // Store the LaTeX for copying
                resultsDiv.dataset.latex = latexOutput;
            }

            // --- Event Listeners for the Circle Splitter ---
            
            // Initial draw when the modal is opened
            $('#circleSplitterModal').on('show.bs.modal', function () {
                // Delaying slightly ensures the canvas is fully visible and sized correctly
                setTimeout(updateCircleSplit, 50); 
            });

            // Recalculate and redraw on input change
            segmentInput.addEventListener('input', updateCircleSplit);
            calculateButton.addEventListener('click', updateCircleSplit);

            // Copy LaTeX result logic
            copyAngleLatexButton.addEventListener('click', async function() {
                const latexToCopy = resultsDiv.dataset.latex || '';
                
                if (latexToCopy) {
                    try {
                        await navigator.clipboard.writeText(latexToCopy);
                        copyAngleLatexButton.textContent = 'Copied! ðŸŽ‰';
                        setTimeout(() => { copyAngleLatexButton.textContent = 'Copy LaTeX'; }, 1500);
                    } catch (err) {
                        copyAngleLatexButton.textContent = 'Failed! ðŸ˜¢';
                        setTimeout(() => { copyAngleLatexButton.textContent = 'Copy LaTeX'; }, 1500);
                    }
                }
            });

            // Initial setup draw
            drawCircle(parseInt(segmentInput.value, 10));

        });
    </script>
</body>
</html>